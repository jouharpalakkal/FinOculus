<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinOculus V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        .card-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- CONFIG MODAL -->
    <div id="configModal" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-2 text-slate-800">Setup Cloud</h2>
            <p class="text-sm text-slate-500 mb-6">Enter your Supabase credentials to sync data.</p>
            <input type="text" id="inputUrl" placeholder="Project URL" class="w-full p-3 border rounded-xl mb-3 bg-slate-50">
            <input type="text" id="inputKey" placeholder="Anon Key" class="w-full p-3 border rounded-xl mb-6 bg-slate-50">
            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Connect</button>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-40 bg-slate-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
                <i class="ri-wallet-3-line text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold mb-1">FinOculus V3</h1>
            <p class="text-slate-400 text-sm mb-6">Sign in via Magic Link (OTP)</p>
            
            <input type="email" id="email" placeholder="Enter your email" class="w-full p-4 border rounded-xl mb-6 bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500 text-center">
            
            <button onclick="handleAuth()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-black transition mb-2 shadow-lg">Send Magic Link</button>
            
            <p id="authMsg" class="mt-4 text-sm font-medium min-h-[20px]"></p>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="appInterface" class="flex-1 flex flex-col h-full hidden relative">
        
        <!-- Top Nav -->
        <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-10">
            <div class="flex items-center gap-2 text-slate-900 font-bold text-xl">
                <i class="ri-wallet-3-fill text-blue-600"></i> FinOculus
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openSettings()" class="text-slate-400 hover:text-slate-700 p-2"><i class="ri-settings-3-line text-xl"></i></button>
                <button onclick="logout()" class="text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-1 rounded-lg">Sign Out</button>
            </div>
        </nav>

        <div class="flex-1 flex overflow-hidden">
            
            <!-- MAIN CONTENT (Dashboard) -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8 pb-32 md:pb-8">
                
                <!-- Accounts Section -->
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-lg font-bold text-slate-700">My Accounts</h2>
                    <button onclick="openAccountModal()" class="text-sm text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-lg hover:bg-blue-100">+ Add Account</button>
                </div>

                <!-- Accounts Horizontal Scroll -->
                <div class="flex gap-4 overflow-x-auto pb-4 mb-6 no-scrollbar" id="accountsList">
                    <!-- Populated by JS -->
                    <div class="min-w-[280px] h-40 rounded-2xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-blue-400 hover:text-blue-500 transition" onclick="openAccountModal()">
                        <i class="ri-add-circle-line text-3xl mb-1"></i>
                        <span class="font-medium">Add First Account</span>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <p class="text-xs text-slate-400 font-bold uppercase">Net Worth</p>
                        <h3 class="text-xl font-bold text-slate-800 mt-1" id="totalNetWorth">...</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <p class="text-xs text-slate-400 font-bold uppercase">Income (Mo)</p>
                        <h3 class="text-xl font-bold text-green-600 mt-1" id="monthIncome">...</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <p class="text-xs text-slate-400 font-bold uppercase">Expense (Mo)</p>
                        <h3 class="text-xl font-bold text-red-500 mt-1" id="monthExpense">...</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <p class="text-xs text-slate-400 font-bold uppercase">Savings (Mo)</p>
                        <h3 class="text-xl font-bold text-blue-600 mt-1" id="monthSavings">...</h3>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <h2 class="text-lg font-bold text-slate-700 mb-4">Recent Activity</h2>
                <div id="transactionsList" class="space-y-3">
                    <!-- JS Populated -->
                </div>
            </main>

            <!-- RIGHT PANEL (Forms) -->
            <aside class="fixed md:relative bottom-0 w-full md:w-[450px] bg-white border-l shadow-2xl z-20 rounded-t-3xl md:rounded-none flex flex-col transition-transform duration-300 translate-y-full md:translate-y-0 h-[85vh] md:h-auto" id="actionPanel">
                
                <!-- Mobile Handle -->
                <div class="md:hidden w-full h-10 flex items-center justify-center cursor-pointer border-b" onclick="togglePanel()">
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
                </div>

                <div class="flex-1 overflow-y-auto p-6">
                    
                    <!-- Favorites / Quick Add -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-slate-400 uppercase">Quick Templates</h3>
                            <button onclick="saveAsFavorite()" class="text-xs text-blue-600 hover:underline">Save current as Favorite</button>
                        </div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="favoritesList">
                            <!-- Populated JS -->
                        </div>
                    </div>

                    <!-- Main Form -->
                    <h2 class="text-xl font-bold text-slate-800 mb-6">New Transaction</h2>
                    <form id="trxForm" class="space-y-5">
                        
                        <!-- Type Selector -->
                        <div class="grid grid-cols-4 gap-2 bg-slate-100 p-1 rounded-xl">
                            <button type="button" onclick="setType('Expense')" class="type-btn active rounded-lg py-2 text-sm font-bold transition text-slate-500 hover:bg-white" data-type="Expense">Exp</button>
                            <button type="button" onclick="setType('Income')" class="type-btn rounded-lg py-2 text-sm font-bold transition text-slate-500 hover:bg-white" data-type="Income">Inc</button>
                            <button type="button" onclick="setType('Savings')" class="type-btn rounded-lg py-2 text-sm font-bold transition text-slate-500 hover:bg-white" data-type="Savings">Save</button>
                            <button type="button" onclick="setType('Transfer')" class="type-btn rounded-lg py-2 text-sm font-bold transition text-slate-500 hover:bg-white" data-type="Transfer">Tfr</button>
                        </div>
                        <input type="hidden" id="type" value="Expense">

                        <!-- Amount -->
                        <div class="relative">
                            <span class="absolute left-0 top-2 text-slate-400 text-sm font-bold" id="inputCurrencyLabel">$</span>
                            <input type="number" id="amount" step="0.01" class="w-full text-4xl font-bold text-slate-800 border-b-2 border-slate-100 focus:border-blue-600 outline-none py-1 bg-transparent pl-8" placeholder="0.00" required>
                        </div>

                        <!-- Date -->
                        <input type="date" id="date" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm font-medium outline-none">

                        <!-- Account Selection -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">From Account</label>
                                <select id="account" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm outline-none font-medium"></select>
                            </div>
                            <div id="toAccountField" class="hidden">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">To Account</label>
                                <select id="toAccount" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm outline-none font-medium"></select>
                            </div>
                        </div>

                        <!-- Category -->
                        <div id="categoryField">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase">Category</label>
                                <button type="button" onclick="openCategoryModal()" class="text-xs text-blue-600 font-bold hover:underline">Manage</button>
                            </div>
                            <select id="category" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm outline-none font-medium"></select>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Note</label>
                            <input type="text" id="desc" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm outline-none" placeholder="What's this for?">
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transform active:scale-95 transition">
                            Save Transaction
                        </button>
                    </form>
                </div>
            </aside>
        </div>

        <!-- Add FAB (Mobile) -->
        <button onclick="togglePanel()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-30 hover:bg-blue-700 transition">
            <i class="ri-add-line"></i>
        </button>

        <!-- ADD ACCOUNT MODAL -->
        <div id="accountModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-2xl w-full max-w-sm m-4 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">Add New Account</h3>
                <input type="text" id="newAccName" placeholder="Account Name (e.g. Chase)" class="w-full p-3 border rounded-xl mb-3">
                <select id="newAccType" class="w-full p-3 border rounded-xl mb-3">
                    <option value="Checking">Checking</option>
                    <option value="Savings">Savings</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Cash">Cash</option>
                    <option value="Investment">Investment</option>
                </select>
                <input type="number" id="newAccBal" placeholder="Current Balance" class="w-full p-3 border rounded-xl mb-6">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('accountModal').classList.add('hidden')" class="flex-1 py-3 text-slate-500 font-bold">Cancel</button>
                    <button onclick="createAccount()" class="flex-1 bg-blue-600 text-white rounded-xl font-bold">Create</button>
                </div>
            </div>
        </div>

        <!-- MANAGE CATEGORIES MODAL -->
        <div id="categoryModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-2xl w-full max-w-sm m-4 shadow-2xl flex flex-col h-[500px]">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h3 class="font-bold text-lg">Manage Categories</h3>
                    <button onclick="document.getElementById('categoryModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="ri-close-line text-2xl"></i></button>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button onclick="filterCatEdit('Expense')" id="catEditExp" class="flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white">Expense</button>
                    <button onclick="filterCatEdit('Income')" id="catEditInc" class="flex-1 py-2 text-xs font-bold rounded-lg bg-slate-100 text-slate-500">Income</button>
                    <button onclick="filterCatEdit('Savings')" id="catEditSav" class="flex-1 py-2 text-xs font-bold rounded-lg bg-slate-100 text-slate-500">Savings</button>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="newCatName" placeholder="New Category Name" class="flex-1 p-2 border rounded-lg text-sm">
                    <button onclick="addCategory()" class="bg-green-600 text-white px-4 rounded-lg font-bold hover:bg-green-700">+</button>
                </div>

                <div id="catEditList" class="flex-1 overflow-y-auto space-y-2 pr-1">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-2xl w-full max-w-sm m-4 shadow-2xl">
                <h3 class="font-bold text-lg mb-4">Settings</h3>
                
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Currency Symbol</label>
                <div class="grid grid-cols-4 gap-2 mb-6">
                    <button onclick="setCurrency('$')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">$</button>
                    <button onclick="setCurrency('€')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">€</button>
                    <button onclick="setCurrency('£')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">£</button>
                    <button onclick="setCurrency('₹')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">₹</button>
                    <button onclick="setCurrency('¥')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">¥</button>
                    <button onclick="setCurrency('₽')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">₽</button>
                    <button onclick="setCurrency('₩')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition">₩</button>
                    <button onclick="setCurrency('Rp')" class="curr-btn p-3 rounded-xl border font-bold hover:bg-blue-50 transition text-xs">Rp</button>
                </div>

                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200">Close</button>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // CONFIG
        let supabaseClient;
        const CONFIG_KEY = 'finoculus_v2_config';
        
        // DEFAULTS
        const DEFAULT_CATEGORIES = {
            'Expense': ['Food & Drink', 'Groceries', 'Transport', 'Utilities', 'Shopping', 'Health', 'Home', 'Entertainment', 'Education'],
            'Income': ['Salary', 'Freelance', 'Business', 'Dividends', 'Gift', 'Refund'],
            'Savings': ['Emergency Fund', 'Retirement', 'Vacation Goal', 'New Car Fund', 'General Savings', 'Investments'],
            'Transfer': ['Transfer'] 
        };

        // GLOBAL STATE
        let accounts = [];
        let transactions = [];
        let favorites = [];
        let userCategories = [];
        let currentCurrency = '$'; // Default
        let currentCatEditType = 'Expense';

        window.onload = () => {
            const savedConfig = JSON.parse(localStorage.getItem(CONFIG_KEY));
            if (savedConfig?.url && savedConfig?.key) {
                initSupabase(savedConfig.url, savedConfig.key);
            } else {
                document.getElementById('configModal').classList.remove('hidden');
            }
            document.getElementById('date').valueAsDate = new Date();
            setType('Expense');
        };

        function saveConfig() {
            const url = document.getElementById('inputUrl').value;
            const key = document.getElementById('inputKey').value;
            if(url && key) {
                localStorage.setItem(CONFIG_KEY, JSON.stringify({url, key}));
                initSupabase(url, key);
                document.getElementById('configModal').classList.add('hidden');
            }
        }

        function initSupabase(url, key) {
            try {
                supabaseClient = window.supabase.createClient(url, key);
                
                // Auth Listener (Better for Magic Link Redirects)
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (session) {
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('appInterface').classList.remove('hidden');
                        loadData();
                    } else {
                        document.getElementById('authScreen').classList.remove('hidden');
                        document.getElementById('appInterface').classList.add('hidden');
                    }
                });

                checkUser();
            } catch (e) { alert("Config Error"); }
        }

        // AUTH
        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appInterface').classList.remove('hidden');
                loadData();
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const msg = document.getElementById('authMsg');
            
            if(!email) {
                msg.innerText = "Please enter your email";
                msg.className = "mt-4 text-sm font-medium text-red-500";
                return;
            }

            msg.innerText = "Sending Magic Link...";
            msg.className = "mt-4 text-sm font-medium text-blue-600";
            
            const { error } = await supabaseClient.auth.signInWithOtp({ 
                email: email,
                options: {
                    emailRedirectTo: window.location.href // Redirect back to this page
                }
            });
            
            if(error) {
                msg.innerText = error.message;
                msg.className = "mt-4 text-sm font-medium text-red-500";
            } else {
                msg.innerText = "Check your email for the login link!";
                msg.className = "mt-4 text-sm font-medium text-green-600";
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        // DATA LOADING
        async function loadData() {
            const user = (await supabaseClient.auth.getUser()).data.user;
            if(!user) return; // Guard

            // 1. Fetch Settings
            const setRes = await supabaseClient.from('user_settings').select('*').single();
            if(setRes.data) {
                currentCurrency = setRes.data.currency_symbol;
            } else {
                // Init settings
                await supabaseClient.from('user_settings').insert([{user_id: user.id, currency_symbol: '$'}]);
            }
            updateCurrencyUI();

            // 2. Fetch Accounts
            const accRes = await supabaseClient.from('accounts').select('*').order('created_at');
            if(accRes.data) accounts = accRes.data;

            // 3. Fetch Favorites
            const favRes = await supabaseClient.from('favorites').select('*');
            if(favRes.data) favorites = favRes.data;

            // 4. Fetch Transactions
            const trxRes = await supabaseClient.from('transactions').select('*').order('transaction_date', {ascending: false}).limit(100);
            if(trxRes.data) transactions = trxRes.data;

            // 5. Fetch Categories
            const catRes = await supabaseClient.from('user_categories').select('*').order('name');
            if(catRes.data && catRes.data.length > 0) {
                userCategories = catRes.data;
            } else {
                await seedCategories(user.id);
            }

            renderApp();
        }

        async function seedCategories(userId) {
            const inserts = [];
            for (const [type, list] of Object.entries(DEFAULT_CATEGORIES)) {
                if(type === 'Transfer') continue;
                list.forEach(name => inserts.push({ user_id: userId, name, type }));
            }
            const { data, error } = await supabaseClient.from('user_categories').insert(inserts).select();
            if(data) userCategories = data;
        }

        // HELPER
        function formatMoney(amount) {
            return `${currentCurrency}${parseFloat(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function updateCurrencyUI() {
            document.getElementById('inputCurrencyLabel').innerText = currentCurrency;
        }

        // RENDERING
        function renderApp() {
            renderAccounts();
            renderStats();
            renderTransactions();
            renderFavorites();
            populateDropdowns();
        }

        function renderAccounts() {
            const container = document.getElementById('accountsList');
            const addBtn = container.lastElementChild;
            
            while (container.firstChild && container.firstChild !== addBtn) {
                container.removeChild(container.firstChild);
            }
            
            if(accounts.length === 0) return;

            accounts.forEach(acc => {
                let icon = 'ri-bank-card-line';
                if(acc.type === 'Cash') icon = 'ri-money-dollar-circle-line';
                if(acc.type === 'Savings') icon = 'ri-safe-2-line';
                if(acc.type === 'Credit Card') icon = 'ri-bank-card-2-line';

                const card = document.createElement('div');
                card.className = "min-w-[280px] h-40 rounded-2xl p-6 text-white card-gradient shadow-lg flex flex-col justify-between relative overflow-hidden";
                card.innerHTML = `
                    <div class="absolute right-[-20px] top-[-20px] text-white opacity-10 text-9xl"><i class="${icon}"></i></div>
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <p class="text-xs font-bold opacity-60 uppercase tracking-wider">${acc.type}</p>
                            <h3 class="text-lg font-bold">${acc.name}</h3>
                        </div>
                        <i class="${icon} text-xl"></i>
                    </div>
                    <div class="z-10">
                        <p class="text-xs opacity-60">Balance (approx)</p>
                        <p class="text-2xl font-bold">${formatMoney(acc.initial_balance)}</p>
                    </div>
                `;
                container.insertBefore(card, addBtn);
            });
        }

        function populateDropdowns() {
            const accSelect = document.getElementById('account');
            const toAccSelect = document.getElementById('toAccount');
            
            const html = accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            accSelect.innerHTML = html;
            toAccSelect.innerHTML = html;
            
            updateCategoryDropdown();
        }

        function updateCategoryDropdown() {
            const type = document.getElementById('type').value;
            const catSelect = document.getElementById('category');
            catSelect.innerHTML = '';
            
            if (type === 'Transfer') {
                catSelect.innerHTML = '<option value="Transfer">Transfer</option>';
            } else {
                const filtered = userCategories.filter(c => c.type === type);
                filtered.forEach(c => {
                    catSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                });
            }
        }

        function renderStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            let inc = 0, exp = 0, save = 0;

            transactions.forEach(t => {
                const d = new Date(t.transaction_date);
                if(d.getMonth() === currentMonth) {
                    const amt = parseFloat(t.amount);
                    if(t.type === 'Income') inc += amt;
                    if(t.type === 'Expense') exp += amt;
                    if(t.type === 'Savings') save += amt;
                }
            });

            document.getElementById('monthIncome').innerText = formatMoney(inc);
            document.getElementById('monthExpense').innerText = formatMoney(exp);
            document.getElementById('monthSavings').innerText = formatMoney(save);
            
            const totalInit = accounts.reduce((sum, a) => sum + parseFloat(a.initial_balance), 0);
            document.getElementById('totalNetWorth').innerText = formatMoney(totalInit); 
        }

        function renderTransactions() {
            const list = document.getElementById('transactionsList');
            list.innerHTML = '';
            transactions.forEach(t => {
                let color = 'text-slate-800';
                let icon = 'ri-bill-line';
                let sign = '-';
                
                if(t.type === 'Income') { color = 'text-green-600'; icon = 'ri-arrow-down-line'; sign = '+'; }
                else if(t.type === 'Transfer') { color = 'text-blue-500'; icon = 'ri-arrow-left-right-line'; sign = ''; }
                else if(t.type === 'Savings') { color = 'text-purple-600'; icon = 'ri-safe-line'; sign = ''; }
                else { color = 'text-slate-800'; icon = 'ri-shopping-bag-3-line'; }

                const accName = accounts.find(a => a.id == t.account_id)?.name || 'Unknown';

                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow-sm flex items-center justify-between";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 text-lg">
                            <i class="${icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-slate-800">${t.description || t.category}</p>
                            <p class="text-xs text-slate-400">${t.transaction_date} • ${accName} • <span class="bg-slate-100 px-1 rounded">${t.category}</span></p>
                        </div>
                    </div>
                    <span class="font-bold ${color}">${sign}${formatMoney(t.amount)}</span>
                `;
                list.appendChild(div);
            });
        }

        function renderFavorites() {
            const list = document.getElementById('favoritesList');
            list.innerHTML = '';
            favorites.forEach(f => {
                const btn = document.createElement('button');
                btn.className = "whitespace-nowrap px-4 py-2 rounded-full bg-blue-50 text-blue-600 font-bold text-xs border border-blue-100 hover:bg-blue-100 transition";
                btn.innerText = f.label;
                btn.onclick = () => applyFavorite(f);
                list.appendChild(btn);
            });
        }

        // SETTINGS & ACTIONS
        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        
        async function setCurrency(symbol) {
            currentCurrency = symbol;
            updateCurrencyUI();
            renderApp();
            
            // Save to DB
            const user = (await supabaseClient.auth.getUser()).data.user;
            await supabaseClient.from('user_settings').upsert({user_id: user.id, currency_symbol: symbol});
            
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // ... (Category and Account logic same as before) ...
        function setType(type) {
            document.getElementById('type').value = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                if(b.dataset.type === type) b.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
            });
            updateCategoryDropdown();
            const toAcc = document.getElementById('toAccountField');
            const catField = document.getElementById('categoryField');
            if(type === 'Transfer') { toAcc.classList.remove('hidden'); catField.classList.add('hidden'); } 
            else { toAcc.classList.add('hidden'); catField.classList.remove('hidden'); }
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            filterCatEdit(document.getElementById('type').value === 'Transfer' ? 'Expense' : document.getElementById('type').value);
        }

        function filterCatEdit(type) {
            currentCatEditType = type;
            ['Expense', 'Income', 'Savings'].forEach(t => {
                const btn = document.getElementById(`catEdit${t.substring(0,3)}`);
                if(t === type) btn.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-blue-600 text-white transition";
                else btn.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-slate-100 text-slate-500 hover:bg-slate-200 transition";
            });
            renderCatEditList();
        }

        function renderCatEditList() {
            const list = document.getElementById('catEditList');
            list.innerHTML = '';
            const filtered = userCategories.filter(c => c.type === currentCatEditType);
            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-slate-50 p-3 rounded-lg";
                div.innerHTML = `<span class="text-sm font-medium">${c.name}</span><button onclick="deleteCategory(${c.id})" class="text-red-400 hover:text-red-600 font-bold px-2">×</button>`;
                list.appendChild(div);
            });
        }

        async function addCategory() {
            const name = document.getElementById('newCatName').value;
            if(!name) return;
            const user = (await supabaseClient.auth.getUser()).data.user;
            const { data, error } = await supabaseClient.from('user_categories').insert([{ user_id: user.id, name: name, type: currentCatEditType }]).select();
            if(!error) { userCategories.push(data[0]); document.getElementById('newCatName').value = ''; renderCatEditList(); updateCategoryDropdown(); }
        }

        async function deleteCategory(id) {
            if(!confirm("Remove this category?")) return;
            const { error } = await supabaseClient.from('user_categories').delete().eq('id', id);
            if(!error) { userCategories = userCategories.filter(c => c.id !== id); renderCatEditList(); updateCategoryDropdown(); }
        }

        async function createAccount() {
            const name = document.getElementById('newAccName').value;
            const type = document.getElementById('newAccType').value;
            const bal = document.getElementById('newAccBal').value;
            const { error } = await supabaseClient.from('accounts').insert([{ name, type, initial_balance: bal, user_id: (await supabaseClient.auth.getUser()).data.user.id }]);
            if(!error) { document.getElementById('accountModal').classList.add('hidden'); loadData(); } else { alert(error.message); }
        }

        document.getElementById('trxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('type').value;
            const user = (await supabaseClient.auth.getUser()).data.user;
            const payload = {
                user_id: user.id,
                amount: document.getElementById('amount').value,
                type: type,
                account_id: document.getElementById('account').value,
                transaction_date: document.getElementById('date').value,
                description: document.getElementById('desc').value,
                category: type === 'Transfer' ? 'Transfer' : document.getElementById('category').value,
                transfer_to_account_id: type === 'Transfer' ? document.getElementById('toAccount').value : null
            };
            const { error } = await supabaseClient.from('transactions').insert([payload]);
            if(error) alert(error.message);
            else { e.target.reset(); setType('Expense'); document.getElementById('date').valueAsDate = new Date(); togglePanel(); loadData(); }
        });

        async function saveAsFavorite() {
            const label = prompt("Name this template (e.g. 'Morning Coffee'):");
            if(!label) return;
            const user = (await supabaseClient.auth.getUser()).data.user;
            const payload = {
                user_id: user.id,
                label: label,
                amount: document.getElementById('amount').value || 0,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                description: document.getElementById('desc').value,
                account_id: document.getElementById('account').value
            };
            await supabaseClient.from('favorites').insert([payload]);
            loadData();
        }

        function applyFavorite(fav) {
            setType(fav.type);
            document.getElementById('amount').value = fav.amount;
            document.getElementById('desc').value = fav.description;
            if(fav.account_id) document.getElementById('account').value = fav.account_id;
            setTimeout(() => { document.getElementById('category').value = fav.category; }, 100);
        }

        function openAccountModal() { document.getElementById('accountModal').classList.remove('hidden'); }
        function togglePanel() { document.getElementById('actionPanel').classList.toggle('translate-y-full'); }
    </script>
</body>
</html>
